{% extends 'base.html' %}
{% block title %}Proyecto {{ proyecto.nombre }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">{{ proyecto.nombre }}</li>
{% endblock %}

{% block content %}
<!-- Encabezado del proyecto -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">
      <i class="fas fa-project-diagram me-2"></i>{{ proyecto.nombre }}
    </h2>
    <p class="text-muted mb-0">
      <i class="fas fa-user me-1"></i>{{ proyecto.usuario }} ·
      <i class="fas fa-calendar me-1"></i>{{ proyecto.fecha_creacion }}
    </p>
  </div>
  <div class="btn-group">
    <button class="btn btn-outline-primary" onclick="window.print()">
      <i class="fas fa-print me-1"></i>Imprimir
    </button>
    <button class="btn btn-outline-success" id="exportExcel">
      <i class="fas fa-file-excel me-1"></i>Exportar
    </button>
  </div>
</div>

<!-- Progreso del proyecto -->
<div class="progress mb-4" style="height: 10px;">
  <div class="progress-bar progress-bar-striped progress-bar-animated" 
       role="progressbar" 
       id="projectProgress"
       style="width: 0%">
  </div>
</div>

<!-- Pestañas de navegación -->
<ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="upload-tab" data-bs-toggle="tab" href="#upload">
      <i class="fas fa-upload me-1"></i>Cargar Datos
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="params-tab" data-bs-toggle="tab" href="#params">
      <i class="fas fa-sliders-h me-1"></i>Parámetros
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="results-tab" data-bs-toggle="tab" href="#results">
      <i class="fas fa-chart-bar me-1"></i>Resultados
    </a>
  </li>
</ul>

<!-- Contenido de las pestañas -->
<div class="tab-content" id="projectTabContent">
  <!-- Pestaña de carga de datos -->
  <div class="tab-pane fade show active" id="upload">
    <div class="card">
      <div class="card-body">
        <form method="post" 
              enctype="multipart/form-data" 
              action="{{ url_for('upload_excel', proyecto_id=proyecto.id) }}"
              id="uploadForm"
              class="needs-validation"
              novalidate>
          <div class="mb-4">
            <label class="form-label">
              <i class="fas fa-file-excel me-1"></i>Archivo Excel
            </label>
            <div class="input-group">
              <input type="file" 
                     class="form-control" 
                     name="excel_file" 
                     accept=".xlsx"
                     required>
              <button class="btn btn-primary" type="submit">
                <i class="fas fa-upload me-1"></i>Subir
              </button>
            </div>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>El archivo debe contener las siguientes columnas:
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Columna</th>
                    <th>Descripción</th>
                    <th>Tipo</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>ID_Equipo</code></td>
                    <td>Identificador único del equipo</td>
                    <td>Texto</td>
                  </tr>
                  <tr>
                    <td><code>Descripcion</code></td>
                    <td>Nombre o descripción del equipo</td>
                    <td>Texto</td>
                  </tr>
                  <tr>
                    <td><code>Potencia_HP</code></td>
                    <td>Potencia en caballos de fuerza</td>
                    <td>Número</td>
                  </tr>
                  <tr>
                    <td><code>Voltaje</code></td>
                    <td>Voltaje nominal del equipo</td>
                    <td>Número</td>
                  </tr>
                  <tr>
                    <td><code>Factor_Potencia</code></td>
                    <td>Factor de potencia del equipo</td>
                    <td>Número</td>
                  </tr>
                  <tr>
                    <td><code>Longitud_m</code></td>
                    <td>Longitud del cable en metros</td>
                    <td>Número</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Pestaña de parámetros -->
  <div class="tab-pane fade" id="params">
    <div class="card">
      <div class="card-body">
        <form method="post" 
              action="{{ url_for('run_calculation', proyecto_id=proyecto.id) }}"
              id="paramsForm"
              class="needs-validation"
              novalidate>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">
                <i class="fas fa-thermometer-half me-1"></i>Temperatura ambiente
              </label>
              <div class="input-group">
                <input type="number" 
                       name="temp_amb" 
                       class="form-control" 
                       required
                       min="-20"
                       max="50">
                <span class="input-group-text">°C</span>
              </div>
              <div class="invalid-feedback">
                Temperatura debe estar entre -20°C y 50°C
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">
                <i class="fas fa-layer-group me-1"></i>Nº conductores
              </label>
              <input type="number" 
                     name="num_cond" 
                     class="form-control" 
                     required
                     min="1"
                     max="20">
              <div class="invalid-feedback">
                Debe ser entre 1 y 20 conductores
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">
                <i class="fas fa-bolt me-1"></i>Voltaje sistema
              </label>
              <div class="input-group">
                <input type="number" 
                       name="voltaje" 
                       class="form-control" 
                       required
                       min="110"
                       max="13800">
                <span class="input-group-text">V</span>
              </div>
              <div class="invalid-feedback">
                Voltaje debe estar entre 110V y 13800V
              </div>
            </div>
          </div>
          <button class="btn btn-primary mt-4" type="submit">
            <i class="fas fa-calculator me-1"></i>Ejecutar Cálculo
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Pestaña de resultados -->
  <div class="tab-pane fade" id="results">
    {% if resultados %}
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="resultsTable">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Descripción</th>
                <th>Corriente (A)</th>
                <th>Calibre</th>
                <th>%Caída</th>
                <th>Canalización</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for r in resultados %}
              <tr>
                <td>{{ r.ID_Equipo }}</td>
                <td>{{ r.Descripcion }}</td>
                <td>{{ '%.2f'|format(r.Corriente) }}</td>
                <td>
                  <span class="badge bg-info">
                    {{ r.Calibre }}
                  </span>
                </td>
                <td>
                  {% if r.Caida_Tension <= 3 %}
                    <span class="text-success">{{ '%.2f'|format(r.Caida_Tension) }}%</span>
                  {% elif r.Caida_Tension <= 5 %}
                    <span class="text-warning">{{ '%.2f'|format(r.Caida_Tension) }}%</span>
                  {% else %}
                    <span class="text-danger">{{ '%.2f'|format(r.Caida_Tension) }}%</span>
                  {% endif %}
                </td>
                <td>{{ r.Canalizacion }}</td>
                <td>
                  {% if r.Caida_Tension <= 3 %}
                    <span class="badge bg-success">OK</span>
                  {% elif r.Caida_Tension <= 5 %}
                    <span class="badge bg-warning">Revisar</span>
                  {% else %}
                    <span class="badge bg-danger">Fuera de rango</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="fas fa-chart-bar fa-3x mb-3"></i>
      <p>No hay resultados disponibles.</p>
      <p>Completa los pasos anteriores para ver los resultados aquí.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Validación de formularios
  const forms = document.querySelectorAll('.needs-validation');
  forms.forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  });

  // Inicializar DataTables en la tabla de resultados
  if (document.getElementById('resultsTable')) {
    $('#resultsTable').DataTable({
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
      },
      dom: '<"d-flex justify-content-between align-items-center"lf>rtip'
    });
  }

  // Actualizar progreso basado en pestañas completadas
  function updateProgress() {
    const tabs = ['upload', 'params', 'results'];
    const completedTabs = tabs.filter(tab => {
      const tabContent = document.getElementById(tab);
      return tabContent.querySelector('form.was-validated') || 
             (tab === 'results' && tabContent.querySelector('table'));
    });
    const progress = (completedTabs.length / tabs.length) * 100;
    document.getElementById('projectProgress').style.width = `${progress}%`;
  }

  // Llamar a updateProgress cuando se muestra una pestaña
  const tabElements = document.querySelectorAll('a[data-bs-toggle="tab"]');
  tabElements.forEach(tab => {
    tab.addEventListener('shown.bs.tab', updateProgress);
  });

  // Exportar a Excel
  document.getElementById('exportExcel').addEventListener('click', () => {
    // Aquí iría la lógica de exportación
    alert('Función de exportación en desarrollo');
  });
</script>
{% endblock %}
